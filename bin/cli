#!/usr/bin/env node

/**
* ig-down CLI
*
* ig-down - 0.1.0 - 21/08/2018
* https://github.com/FranciscoKnebel/ig-down#readme
* Francisco Knebel <franciscopaivaknebel@gmail.com> (https://github.com/FranciscoKnebel/)
*/

/**
* MIT License
*
* Copyright (c) 2018 Francisco Knebel
*
* Permission is hereby granted, free of charge, to any person obtaining a copy
* of this software and associated documentation files (the "Software"), to deal
* in the Software without restriction, including without limitation the rights
* to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
* copies of the Software, and to permit persons to whom the Software is
* furnished to do so, subject to the following conditions:
*
* The above copyright notice and this permission notice shall be included in all
* copies or substantial portions of the Software.
*
* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
* IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
* FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
* AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
* LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
* OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
* SOFTWARE.
*/
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var fs=require("fs"),fs$1=require("fs-extra"),fs$1__default=_interopDefault(fs$1);require("util");var moment=_interopDefault(require("moment")),puppeteer=_interopDefault(require("puppeteer")),request=_interopDefault(require("requestretry")),path=require("path"),program=_interopDefault(require("commander"));function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}var runtime=createCommonjsModule(function(F){!function(e){var s,t=Object.prototype,l=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},o=r.iterator||"@@iterator",n=r.asyncIterator||"@@asyncIterator",i=r.toStringTag||"@@toStringTag",a=e.regeneratorRuntime;if(a)F.exports=a;else{(a=e.regeneratorRuntime=F.exports).wrap=y;var f="suspendedStart",p="suspendedYield",d="executing",h="completed",g={},c={};c[o]=function(){return this};var u=Object.getPrototypeOf,m=u&&u(u(D([])));m&&m!==t&&l.call(m,o)&&(c=m);var v=_.prototype=w.prototype=Object.create(c);x.prototype=v.constructor=_,_.constructor=x,_[i]=x.displayName="GeneratorFunction",a.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},a.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,_):(e.__proto__=_,i in e||(e[i]="GeneratorFunction")),e.prototype=Object.create(v),e},a.awrap=function(e){return{__await:e}},S(L.prototype),L.prototype[n]=function(){return this},a.AsyncIterator=L,a.async=function(e,t,r,n){var o=new L(y(e,t,r,n));return a.isGeneratorFunction(t)?o:o.next().then(function(e){return e.done?e.value:o.next()})},S(v),v[i]="Generator",v[o]=function(){return this},v.toString=function(){return"[object Generator]"},a.keys=function(r){var n=[];for(var e in r)n.push(e);return n.reverse(),function e(){for(;n.length;){var t=n.pop();if(t in r)return e.value=t,e.done=!1,e}return e.done=!0,e}},a.values=D,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=s,this.done=!1,this.delegate=null,this.method="next",this.arg=s,this.tryEntries.forEach(E),!e)for(var t in this)"t"===t.charAt(0)&&l.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=s)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var n=this;function e(e,t){return i.type="throw",i.arg=r,n.next=e,t&&(n.method="next",n.arg=s),!!t}for(var t=this.tryEntries.length-1;0<=t;--t){var o=this.tryEntries[t],i=o.completion;if("root"===o.tryLoc)return e("end");if(o.tryLoc<=this.prev){var a=l.call(o,"catchLoc"),c=l.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return e(o.catchLoc,!0);if(this.prev<o.finallyLoc)return e(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return e(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return e(o.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;0<=r;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&l.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var i=o?o.completion:{};return i.type=e,i.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),E(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;0<=t;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;E(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:D(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=s),g}}}function y(e,t,r,n){var i,a,c,s,o=t&&t.prototype instanceof w?t:w,l=Object.create(o.prototype),u=new O(n||[]);return l._invoke=(i=e,a=r,c=u,s=f,function(e,t){if(s===d)throw new Error("Generator is already running");if(s===h){if("throw"===e)throw t;return G()}for(c.method=e,c.arg=t;;){var r=c.delegate;if(r){var n=j(r,c);if(n){if(n===g)continue;return n}}if("next"===c.method)c.sent=c._sent=c.arg;else if("throw"===c.method){if(s===f)throw s=h,c.arg;c.dispatchException(c.arg)}else"return"===c.method&&c.abrupt("return",c.arg);s=d;var o=b(i,a,c);if("normal"===o.type){if(s=c.done?h:p,o.arg===g)continue;return{value:o.arg,done:c.done}}"throw"===o.type&&(s=h,c.method="throw",c.arg=o.arg)}}),l}function b(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}function w(){}function x(){}function _(){}function S(e){["next","throw","return"].forEach(function(t){e[t]=function(e){return this._invoke(t,e)}})}function L(s){var t;this._invoke=function(r,n){function e(){return new Promise(function(e,t){!function t(e,r,n,o){var i=b(s[e],s,r);if("throw"!==i.type){var a=i.arg,c=a.value;return c&&"object"==typeof c&&l.call(c,"__await")?Promise.resolve(c.__await).then(function(e){t("next",e,n,o)},function(e){t("throw",e,n,o)}):Promise.resolve(c).then(function(e){a.value=e,n(a)},function(e){return t("throw",e,n,o)})}o(i.arg)}(r,n,e,t)})}return t=t?t.then(e,e):e()}}function j(e,t){var r=e.iterator[t.method];if(r===s){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=s,j(e,t),"throw"===t.method))return g;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return g}var n=b(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,g;var o=n.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=s),t.delegate=null,g):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,g)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function E(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function D(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,n=function e(){for(;++r<t.length;)if(l.call(t,r))return e.value=t[r],e.done=!1,e;return e.value=s,e.done=!0,e};return n.next=n}}return{next:G}}function G(){return{value:s,done:!0}}}(function(){return this||"object"==typeof self&&self}()||Function("return this")())}),g=function(){return this||"object"==typeof self&&self}()||Function("return this")(),hadRuntime=g.regeneratorRuntime&&0<=Object.getOwnPropertyNames(g).indexOf("regeneratorRuntime"),oldRuntime=hadRuntime&&g.regeneratorRuntime;g.regeneratorRuntime=void 0;var runtimeModule=runtime;if(hadRuntime)g.regeneratorRuntime=oldRuntime;else try{delete g.regeneratorRuntime}catch(e){g.regeneratorRuntime=void 0}var regenerator=runtimeModule;function asyncGeneratorStep(e,t,r,n,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void r(e)}c.done?t(s):Promise.resolve(s).then(n,o)}function _asyncToGenerator(c){return function(){var e=this,a=arguments;return new Promise(function(t,r){var n=c.apply(e,a);function o(e){asyncGeneratorStep(n,t,r,o,i,"next",e)}function i(e){asyncGeneratorStep(n,t,r,o,i,"throw",e)}o(void 0)})}}var asyncToGenerator=_asyncToGenerator;function mkdir(e){return fs$1.ensureDirSync(e)}function getTime(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:":";return"".concat(moment().format("DD/MM/YYYY-HH:mm:ss")).concat(e)}function log(e){console.log(getTime(),e)}function extractor(){var e=document.querySelectorAll("img"),t=[],r=!0,n=!1,o=void 0;try{for(var i,a=e[Symbol.iterator]();!(r=(i=a.next()).done);r=!0){var c=i.value;if(!c.alt.endsWith("profile picture")){var s=c.parentNode.parentNode.parentNode.href.split("/?taken-by")[0];t.push({id:s.split("/p/")[1],a:s,src:c.src})}}}catch(e){n=!0,o=e}finally{try{r||null==a.return||a.return()}finally{if(n)throw o}}return t}function inArray(e,t){for(var r=0;r<e.length;r+=1)if(t(e[r]))return!0;return!1}function pushIfNotExist(e,t,r){inArray(e,r)||e.push(t)}function scroller(e,t,r){return _scroller.apply(this,arguments)}function _scroller(){return(_scroller=asyncToGenerator(regenerator.mark(function e(t,r,n){var o,i,a,c,s,l,u,f,p,d,h=arguments;return regenerator.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:o=3<h.length&&void 0!==h[3]?h[3]:1e3,i=[],a=[],e.prev=3;case 4:if(!(i.length<n)){e.next=39;break}return e.next=7,t.evaluate(r);case 7:for(a=e.sent,l=!(s=!0),u=void 0,e.prev=11,f=function(){var t=d.value;pushIfNotExist(i,t,function(e){return e.id===t.id})},p=a[Symbol.iterator]();!(s=(d=p.next()).done);s=!0)f();e.next=20;break;case 16:e.prev=16,e.t0=e.catch(11),l=!0,u=e.t0;case 20:e.prev=20,e.prev=21,s||null==p.return||p.return();case 23:if(e.prev=23,!l){e.next=26;break}throw u;case 26:return e.finish(23);case 27:return e.finish(20);case 28:return e.next=30,t.evaluate("document.body.scrollHeight");case 30:return c=e.sent,e.next=33,t.evaluate("window.scrollTo(0, document.body.scrollHeight)");case 33:return e.next=35,t.waitForFunction("document.body.scrollHeight > ".concat(c));case 35:return e.next=37,t.waitFor(o);case 37:e.next=4;break;case 39:e.next=44;break;case 41:throw e.prev=41,e.t1=e.catch(3),e.t1;case 44:return e.abrupt("return",i);case 45:case"end":return e.stop()}},e,this,[[3,41],[11,16,20,28],[21,,23,27]])}))).apply(this,arguments)}function scraper(e){var l=e.user,u=e.amount,f=e.dist;return asyncToGenerator(regenerator.mark(function e(){var t,r,n,o,i,a,c,s;return regenerator.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,puppeteer.launch({timeout:0,headless:!1});case 2:return t=e.sent,e.next=5,t.newPage();case 5:return r=e.sent,mkdir("".concat(f,"/").concat(l)),log("Loading user page of '".concat(l,"'..")),e.next=10,r.goto("https://www.instagram.com/".concat(l));case 10:return e.next=12,r.setViewport({width:640,height:1080});case 12:return log("Page loaded."),log("Scrolling through page..."),e.next=16,scroller(r,extractor,u,200);case 16:for(n=e.sent,log("Done it!"),log("Creating file with image links for user '".concat(l,"'.")),o=fs$1__default.createWriteStream("".concat(f,"/").concat(l,"/pending.txt"),{flags:"a"}),i=0;i<n.length;i+=1)if(a=n[i],c="".concat(f,"/").concat(l,"/").concat(n.length-1-i,".").concat(a.id,".jpg"),s="".concat(a.a,"/media/?size=l"),fs$1__default.existsSync(c))console.log("Skipping ".concat(a.id));else try{o.write("".concat(s,"\n"))}catch(e){console.error(e,s)}return o.end(),log("File written and closed."),e.next=25,t.close();case 25:return e.abrupt("return",n.length);case 26:case"end":return e.stop()}},e,this)}))()}function delayStrategy(){return Math.floor(3001*Math.random()+500)}function downloadAndSave(e,t){return request({url:e,delayStrategy:delayStrategy}).pipe(fs.createWriteStream(t)).on("close",function(){return log("Saved ".concat(e," to ").concat(t))})}function download(n,e){var o="".concat(e.dist,"/").concat(n);log('Downloading images from "'.concat(n,'..."')),fs.readFile("".concat(o,"/pending.txt"),"utf8",function(e,t){if(e)throw e;t.toString().split("\n").forEach(function(e,t){if(0<e.length){var r=e.split("/p/")[1].split("/media")[0];log("[".concat(t,"] ").concat(n," => downloading ").concat(e,".")),downloadAndSave(e,"".concat(o,"/").concat(t,".").concat(r,".jpg"))}}),fs.unlinkSync("".concat(o,"/pending.txt"))})}function downloadAllUsers(e){var t,r=(t=e,fs.readdirSync(t).filter(function(e){return fs.statSync(path.join(t,e)).isDirectory()}));log("Downloading images from ".concat(r.length," users."));var n=!0,o=!1,i=void 0;try{for(var a,c=r[Symbol.iterator]();!(n=(a=c.next()).done);n=!0){download(a.value)}}catch(e){o=!0,i=e}finally{try{n||null==c.return||c.return()}finally{if(o)throw i}}}moment.locale("pt-br");var defaultOptions={dist:"dl",user:{amount:10,save:!1},download:{all:!1}},name="ig-down",version="0.1.0",description="IG CLI downloader.",main="index.js",scripts={start:"node -r esm src/cli.js",test:"npm run test:lint && npm run test:ava","test:lint":"eslint src build tests","test:ava":"ava",build:"npm run build:bundle && npm run build:executable","build:bundle":"node -r esm build/bundle.js","build:executable":"chmod +x bin/cli bin/cli.js",dev:""},repository={type:"git",url:"git+https://github.com/FranciscoKnebel/ig-down.git"},author="Francisco Knebel <franciscopaivaknebel@gmail.com> (https://github.com/FranciscoKnebel/)",license="MIT",bugs={url:"https://github.com/FranciscoKnebel/ig-down/issues"},homepage="https://github.com/FranciscoKnebel/ig-down#readme",dependencies={"@babel/runtime":"^7.0.0-rc.1",cheerio:"^1.0.0-rc.2",colors:"^1.3.1",commander:"^2.17.1",dotenv:"^6.0.0","fs-extra":"^7.0.0",moment:"^2.22.2",puppeteer:"^1.6.2",request:"^2.87.0","request-promise-native":"^1.0.5",requestretry:"^2.0.2",util:"^0.11.0"},devDependencies={"@babel/cli":"^7.0.0-rc.1","@babel/core":"^7.0.0-rc.1","@babel/plugin-external-helpers":"^7.0.0-rc.1","@babel/plugin-transform-runtime":"^7.0.0-rc.1","@babel/polyfill":"^7.0.0-rc.1","@babel/preset-env":"^7.0.0-rc.1","@babel/register":"^7.0.0-rc.1",ava:"1.0.0-beta.7","babel-eslint":"^8.2.6",bufferutil:"^4.0.0","del-cli":"^1.1.0",eslint:"^4.19.1","eslint-config-airbnb":"^16.1.0","eslint-plugin-ava":"^5.1.0","eslint-plugin-import":"^2.9.0","eslint-plugin-jsx-a11y":"^6.0.3","eslint-plugin-react":"^7.6.1",esm:"^3.0.78",nyc:"^12.0.2",rollup:"^0.64.1","rollup-plugin-babel":"^4.0.0-beta.8","rollup-plugin-commonjs":"^9.1.5","rollup-plugin-json":"^3.0.0","rollup-plugin-multi-entry":"^2.0.2","rollup-plugin-node-resolve":"^3.3.0","rollup-plugin-replace":"^2.0.0","rollup-plugin-uglify":"^4.0.0",tempy:"^0.2.1","uglify-js":"^3.4.7","utf-8-validate":"^5.0.1"},bin={"ig-down":"bin/cli"},files=["bin/**/*"],preferGlobal=!0,pkg={name:name,version:version,description:description,main:main,scripts:scripts,repository:repository,author:author,license:license,bugs:bugs,homepage:homepage,dependencies:dependencies,devDependencies:devDependencies,bin:bin,files:files,preferGlobal:preferGlobal};program.version(pkg.version).description(pkg.description),program.command("user <name>").alias("u").description("Get images from user.").option("-A, --amount <number>","The minimum amount of images expected to download. (default: ".concat(defaultOptions.user.amount,")")).option("-D, --destination <path>",'Destination folder. (default: "'.concat(defaultOptions.dist,'")')).option("-S, --save","After getting the image links, download the image files. (default: ".concat(defaultOptions.user.save,")")).action(function(e,t){var r={user:e,amount:t.amount||defaultOptions.user.amount,dist:t.destination||defaultOptions.dist,save:t.save||defaultOptions.user.save};scraper(r).then(function(){r.save&&download(r.user,r)})}),program.command("download").alias("d").description("Download images already obtained from users.").option("-U, --user <name>","Download all pending images from a user.").option("-A, --all","Download all pending images from all users. (default: ".concat(defaultOptions.download.all,")")).option("-D, --destination <path>",'Destination folder. (default: "'.concat(defaultOptions.dist,'")')).action(function(e){var t={dist:e.destination||defaultOptions.dist};e.all?downloadAllUsers(t.dist):e.user?download(e.user,t):console.log('"user" or "all" option needs to be defined.')}),program.on("command:*",function(){console.error("Invalid command: %s\nSee --help for a list of available commands.",program.args.join(" ")),process.exit(1)}),program.parse(process.argv),process.argv.slice(2).length||program.outputHelp();